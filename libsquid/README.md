## liblogsquid

It's a library of utility functions to manipulate the registration line generated by the Squid-cache proxy.<br>
The main function *log_squid()*, allows us to retrieve only the information from the part of the log that interests us in a very simple way.<br>
The motivation to write these routines, in addition to the study and improvement of techniques, was due to the fact that this type of approach frees us from the SERDE routines in Java, usually written for data collection systems such as Apache Flume.<br>
So, very naturally, we can use these functions directly in SQL statements.

When we need new functions or have ideas about a new function, we will implement it in the project.


## Instructions

### To compile and install liblocation

git clone https://github.com/vcputtini/mysql-mariadb-udf-cpp  <br>
cd libsquid  <br>
make            <br>
make install    <br>  

### Create UDF's

To create (register) the UDF's to used in the database, we will use the DDL's that are encoded in the __docs/create-funcs.sql__ file.

__Line command:__ Using mysql command.

mysql [-p] [-D test] <  docs/create-funcs.sql

## References

* Syntax<br>
_string log_squid(string,string,string);_<br>
Arguments:<br>
1st: One these: squid | common | combined | referrer | useragent<br>
2nd: Reserved Words: see list docs/reserved-words.txt<br>
3rd: Log line<br>
Comments: The function will always return the values in the string type.

* Supported Squid Log Formats<br>
Up to this point the *log_squid()* can handle the default formats of Squid's log types, as follows:<br><br>
Log Format: squid<br>
%ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt<br>
UDF Reserved Word: squid<br><br>
Log Format: common<br>
%>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st %Ss:%Sh<br>
UDF Reserved Word: common<br><br>
Log Format: combined<br>
%>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh<br>
UDF Reserved Word: combined<br><br>
Log Format: referrer<br>
%ts.%03tu %>a %{Referer}>h %ru<br>
UDF Reserved Word: referrer<br><br>
Log Format: useragent<br>
%>a [%tl] "%{User-Agent}>h"<br>
UDF Reserved Word: useragent<br>

* Reserved words to retrieve parts of the log<br>
The complete list of words reserved for use in the function can be found in the *docs/reserved-words.txt* file

* Usage Examples<br>
select log_squid("squid", "unix_timestamp",
'1590128490.529   399 192.168.100.25 TAG_NONE/200 0 CONNECT 2.22.197.191:443 - ORIGINAL_DST/2.22.197.191 -'
);<br>
Returns: 1590128490.529<br>
select squid_logparts("combined", "client_src_ip_addr", FLD_LOG);<br>
Returns: 172.16.50.100<br><br>
slog = 1591165807.622      6 192.168.100.53 TCP_DENIED/403 **4131** POST http://su.ff.avast.com/R/A2QKIDVjOTFjZDExOTQ1MzQzZmViMTc3NzUzMDg4MTRiYzhlEgQEAgYgGKwCIgEAKgcIBBCjsex6OLCYjKABQiAAAAAAAAAAAAAAAAAAAAAA1rqmBFGB-l10EdXP6TiASUiAg5gI - HIER_NONE/- text/html<br>
select squid_totalsize_req("squid", slog) as tot
from squidlog;<br>
Returns: 4131<br><br>
select<br>
  log_squid("squid", "total_req_size",slog) as IP<br>
from squidlog<br>
where
  log_squid("squid", "client_src_ip_addr",slog) = "192.168.11.22";<br><br>
select count(*) from squid_useragent<br>
where log_squid("useragent","user_agent",log) like '%Mozilla%';<br><br>
MariaDB [test]> select count(*) from squid_useragent where log_squid("useragent","user_agent",log) like '%Mozilla%';<br>

+----------+<br>
| count(*) |<br>
+----------+<br>
|      624 |<br>
+----------+<br>
1 row in set (0.075 sec)<br>
